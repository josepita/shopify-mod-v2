{% extends "base.html" %}
{% block content %}
<div class="card p-3 mb-3">
  <h3 class="h5">Catálogo desde CSV</h3>
  {% if not has_data %}
    <p class="text-muted">Sube un CSV/XLS(X) para analizar qué productos están subidos a Shopify.</p>
  {% endif %}
  {% if error %}
    <p class="text-danger">{{ error }}</p>
  {% endif %}
  <form action="/catalog/upload" method="post" enctype="multipart/form-data" class="mt-2 d-flex gap-2 align-items-end">
    <div>
      <label for="file">Archivo de productos (XLS/XLSX/CSV)</label>
      <input class="form-control" type="file" id="file" name="file" required>
    </div>
    <button class="btn btn-primary" type="submit">Cargar</button>
  </form>
</div>

{% if has_data %}
<div class="card p-3 mb-3">
  <h4 class="h6">Estadísticas</h4>
  <div class="row row-cols-2 row-cols-md-4 g-2">
    <div class="col"><div class="p-2 border rounded">Filas CSV: <strong>{{ metrics.total_rows }}</strong></div></div>
    <div class="col"><div class="p-2 border rounded">Productos base: <strong>{{ metrics.total_products }}</strong></div></div>
    <div class="col"><div class="p-2 border rounded">Variantes totales: <strong>{{ metrics.total_variants }}</strong></div></div>
    <div class="col"><div class="p-2 border rounded">Subidos: <strong>{{ metrics.subidos }}</strong></div></div>
    <div class="col"><div class="p-2 border rounded">Pendientes: <strong>{{ metrics.pendientes }}</strong></div></div>
    <div class="col"><div class="p-2 border rounded">Cobertura: <strong>{{ metrics.coverage }}%</strong></div></div>
    <div class="col"><div class="p-2 border rounded">Variantes subidas: <strong>{{ metrics.variants_subidas }}</strong></div></div>
  </div>
</div>

<div class="card p-3 mb-3">
  <h4 class="h6">Validación CSV</h4>
  {% if validation and not validation.ok %}
    <div class="alert alert-danger mb-2">
      Faltan columnas requeridas: {{ validation.missing_columns | join(', ') }}
    </div>
  {% else %}
    <div class="alert alert-success mb-2">Estructura de columnas OK</div>
  {% endif %}
  <div class="row row-cols-2 row-cols-md-4 g-2">
    <div class="col"><div class="p-2 border rounded">Precio = 0: <strong>{{ validation.stats.zero_prices.count }}</strong> ({{ validation.stats.zero_prices.percent }}%)</div></div>
    <div class="col"><div class="p-2 border rounded">Stock = 0: <strong>{{ validation.stats.zero_stock.count }}</strong> ({{ validation.stats.zero_stock.percent }}%)</div></div>
  </div>
  {% if validation.notes and validation.notes|length > 0 %}
    <ul class="mt-2 text-warning">
      {% for n in validation.notes %}<li>{{ n }}</li>{% endfor %}
    </ul>
  {% endif %}
</div>

<div class="card p-3 mb-3">
  <h4 class="h6">Filtros</h4>
  <form action="/catalog" method="get" class="d-flex gap-3 flex-wrap align-items-end">
    <div>
      <label for="q">Buscar</label>
      <input class="form-control" type="text" id="q" name="q" value="{{ q }}" placeholder="Referencia, categoría, subcategoría...">
    </div>
    <div>
      <label for="categoria">Categoría</label>
      <select class="form-select" id="categoria" name="categoria">
        <option value="">(Todas)</option>
        {% for c in categorias %}
          <option value="{{ c }}" {% if categoria==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="subcategoria">Subcategoría</label>
      <select class="form-select" id="subcategoria" name="subcategoria">
        <option value="">(Todas)</option>
        {% for sc in subcategorias %}
          <option value="{{ sc }}" {% if subcategoria==sc %}selected{% endif %}>{{ sc }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="estado">Estado</label>
      <select class="form-select" id="estado" name="estado">
        <option value="todos" {% if estado=='todos' %}selected{% endif %}>Todos</option>
        <option value="subido" {% if estado=='subido' %}selected{% endif %}>Subidos</option>
        <option value="pendiente" {% if estado=='pendiente' %}selected{% endif %}>Pendientes</option>
      </select>
    </div>
    <div>
      <label for="per_page">Por página</label>
      <input class="form-control" type="number" id="per_page" name="per_page" min="1" max="1000" value="{{ per_page or 50 }}" style="width:120px;">
    </div>
    <div>
      <button class="btn btn-outline-primary" type="submit">Aplicar</button>
      <a class="btn btn-outline-secondary" href="/catalog/export?estado={{ estado }}&q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}">Exportar ({{ estado if estado!='todos' else 'pendiente' }})</a>
    </div>
  </form>
</div>

<div class="card p-3 mb-3">
  <h4 class="h6">Resultados</h4>
  <div class="text-muted mb-2">Mostrando página {{ page }} de {{ pages }} — {{ total }} resultados</div>
  <form action="/catalog/export" method="get">
  <input type="hidden" name="q" value="{{ q }}">
  <input type="hidden" name="categoria" value="{{ categoria }}">
  <input type="hidden" name="subcategoria" value="{{ subcategoria }}">
  <input type="hidden" name="estado" value="{{ estado }}">
  <table class="table table-striped table-sm align-middle table-fixed">
    <thead>
      <tr>
        <th style="width:36px;"><input class="form-check-input" type="checkbox" id="chkAll" onclick="toggleAll(this)"></th>
        {% set dirflip = 'desc' if sort_dir=='asc' else 'asc' %}
        <th style="width:90px;">Imagen</th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=referencia&sort_dir={{ dirflip if sort_by=='referencia' else 'asc' }}">Referencia</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=descripcion&sort_dir={{ dirflip if sort_by=='descripcion' else 'asc' }}">Descripción</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=categoria&sort_dir={{ dirflip if sort_by=='categoria' else 'asc' }}">Categoría</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=subcategoria&sort_dir={{ dirflip if sort_by=='subcategoria' else 'asc' }}">Subcategoría</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=tipo&sort_dir={{ dirflip if sort_by=='tipo' else 'asc' }}">Tipo</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=precio&sort_dir={{ dirflip if sort_by=='precio' else 'asc' }}">Precio</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=stock&sort_dir={{ dirflip if sort_by=='stock' else 'asc' }}">Stock</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=variantes&sort_dir={{ dirflip if sort_by=='variantes' else 'asc' }}">Variantes</a></th>
        <th><a href="/catalog?q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}&estado={{ estado }}&per_page={{ per_page }}&sort_by=estado&sort_dir={{ dirflip if sort_by=='estado' else 'asc' }}">Estado</a></th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for r in records %}
        <tr>
          <td><input class="form-check-input" type="checkbox" name="selected" value="{{ r.referencia }}"></td>
          <td>
            {% if r.imagen_url %}
              {% set imgsrc = r.imagen_url if r.imagen_url.startswith('http') else 'https://' ~ r.imagen_url %}
              <img class="thumb" src="{{ imgsrc }}" alt="{{ r.descripcion }}">
            {% endif %}
          </td>
          <td>{{ r.referencia }}</td>
          <td>{{ r.descripcion }}</td>
          <td>{{ r.categoria }}</td>
          <td>{{ r.subcategoria }}</td>
          <td>{{ r.tipo }}</td>
          <td>{{ r.precio }}</td>
          <td>{{ r.stock }}</td>
          <td>{{ r.variantes }}</td>
          <td>{% if r.estado=='subido' %}<span class="badge text-bg-success">Subido</span>{% else %}<span class="badge text-bg-warning text-dark">Pendiente</span>{% endif %}</td>
          <td>
            <button type="button" class="btn btn-sm btn-outline-secondary" data-ref="{{ r.referencia }}" onclick="showPreview(this)">Ver datos Shopify</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" type="submit">Exportar seleccionados</button>
    <a class="btn btn-outline-secondary" href="/catalog/export?estado={{ estado }}&q={{ q }}&categoria={{ categoria }}&subcategoria={{ subcategoria }}">Exportar filtrado</a>
  </div>
  </form>
  <div class="d-flex gap-2 mt-2">
    {% set qparams = 'q=' ~ q ~ '&categoria=' ~ categoria ~ '&subcategoria=' ~ subcategoria ~ '&estado=' ~ estado ~ '&per_page=' ~ (per_page or 50) %}
    {% if page > 1 %}
      <a class="btn btn-outline-secondary" href="/catalog?{{ qparams }}&page=1">« Primera</a>
      <a class="btn btn-outline-secondary" href="/catalog?{{ qparams }}&page={{ page - 1 }}">‹ Anterior</a>
    {% endif %}
    {% if page < pages %}
      <a class="btn btn-outline-secondary" href="/catalog?{{ qparams }}&page={{ page + 1 }}">Siguiente ›</a>
      <a class="btn btn-outline-secondary" href="/catalog?{{ qparams }}&page={{ pages }}">Última »</a>
    {% endif %}
  </div>
</div>

<div class="card p-3 mb-3">
  <h4 class="h6">Descatalogados (últimos <span id="dc-days">3</span> días)</h4>
  <form class="d-flex gap-2 align-items-end" onsubmit="event.preventDefault(); loadDiscontinued();">
    <div>
      <label for="dc_categoria">Categoría</label>
      <select class="form-select" id="dc_categoria">
        <option value="">(Todas)</option>
        {% for c in categorias %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="dc_subcategoria">Subcategoría</label>
      <select class="form-select" id="dc_subcategoria">
        <option value="">(Todas)</option>
        {% for sc in subcategorias %}
          <option value="{{ sc }}">{{ sc }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="dc_days">Días</label>
      <input class="form-control" type="number" id="dc_days" value="3" min="1" max="30" style="width:120px;">
    </div>
    <button class="btn btn-outline-primary" type="submit">Refrescar</button>
  </form>
  <div id="dc_info" class="text-muted mt-2">Sin datos aún.</div>
  <div class="table-responsive mt-2">
    <table class="table table-sm table-striped align-middle" id="dc_table" style="display:none;">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>Referencia base</th>
          <th>Descripción</th>
          <th>Categoría</th>
          <th>Subcategoría</th>
          <th>Tipo</th>
          <th>Última vez visto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<!-- Modal Bootstrap para preview -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Datos para Shopify</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="previewContent" class="small text-muted">Cargando…</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
  </div>

<script>
  async function showPreview(btn) {
    const ref = btn.getAttribute('data-ref');
    const modalEl = document.getElementById('previewModal');
    const content = document.getElementById('previewContent');
    content.innerHTML = 'Cargando…';
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
    try {
      const res = await fetch(`/catalog/preview/${encodeURIComponent(ref)}`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error');
      content.innerHTML = renderPreview(data);
    } catch (e) {
      content.innerHTML = `<div class="text-danger">${e.message}</div>`;
    }
  }

  function renderPreview(data) {
    const p = data.producto || {};
    const imgs = (p.images || []).map(img => `<img src="${img.src}" alt="img" class="me-2 mb-2" style="max-height:100px; border:1px solid #eee; border-radius:4px;">`).join('');
    const metas = p.metafields ? Object.entries(p.metafields).filter(([k,v]) => v).map(([k,v]) => `<li><strong>${k}:</strong> ${v}</li>`).join('') : '';
    const variants = (data.variantes || []).map(v => `
      <li>
        SKU: ${v.sku} — Talla: ${v.size} — Precio: ${v.price} — Stock: ${v.stock} — Peso: ${v.weight} g
      </li>
    `).join('');
    return `
      <div class="mb-2"><strong>Referencia:</strong> ${data.referencia || ''}</div>
      <div class="mb-2"><strong>Título:</strong> ${p.title || ''}</div>
      <div class="mb-2"><strong>SKU:</strong> ${p.sku || ''}</div>
      <div class="mb-2"><strong>Tipo:</strong> ${p.product_type || ''}</div>
      <div class="mb-2"><strong>Precio:</strong> ${p.price || ''} — <strong>Stock:</strong> ${p.stock || ''} — <strong>Peso:</strong> ${p.weight || ''} g</div>
      <div class="mb-2"><strong>Tags:</strong> ${p.tags || ''}</div>
      ${metas ? `<div class="mb-2"><strong>Metafields</strong><ul class="mb-2">${metas}</ul></div>` : ''}
      ${imgs ? `<div class="mb-2"><strong>Imágenes</strong><div class="d-flex flex-wrap">${imgs}</div></div>` : ''}
      ${variants ? `<div class="mb-2"><strong>Variantes</strong><ul>${variants}</ul></div>` : ''}
    `;
  }

  function toggleAll(master) {
    document.querySelectorAll('input[name="selected"]').forEach(ch => ch.checked = master.checked);
  }

  async function loadDiscontinued() {
    const days = document.getElementById('dc_days').value || 3;
    document.getElementById('dc-days').innerText = days;
    const categoria = document.getElementById('dc_categoria').value || '';
    const subcategoria = document.getElementById('dc_subcategoria').value || '';
    const info = document.getElementById('dc_info');
    const table = document.getElementById('dc_table');
    table.style.display = 'none';
    info.innerText = 'Cargando…';
    try {
      const url = `/catalog/discontinued?days=${encodeURIComponent(days)}&categoria=${encodeURIComponent(categoria)}&subcategoria=${encodeURIComponent(subcategoria)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error');
      info.innerText = `Referencias base descatalogadas: ${data.count}`;
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      for (const it of (data.items || [])) {
        const img = it.imagen1 ? (it.imagen1.startsWith('http') ? it.imagen1 : 'https://' + it.imagen1) : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${img ? `<img src="${img}" class="thumb">` : ''}</td>
          <td>${it.base_reference || ''}</td>
          <td>${it.descripcion || ''}</td>
          <td>${it.categoria || ''}</td>
          <td>${it.subcategoria || ''}</td>
          <td>${it.tipo || ''}</td>
          <td>${it.last_seen || ''}</td>
        `;
        tbody.appendChild(tr);
      }
      table.style.display = '';
    } catch (e) {
      info.innerHTML = `<span class="text-danger">${e.message}</span>`;
    }
  }

  // Cargar al abrir la página si hay datos
  {% if has_data %}loadDiscontinued();{% endif %}
</script>

{% endif %}
{% endblock %}
